"use strict";(self.webpackChunkpersonal_blog=self.webpackChunkpersonal_blog||[]).push([[695],{7021:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>d,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"discord/discord","title":"How to create a multi-server discord economy bot","description":"Intro","source":"@site/docs/discord/discord.mdx","sourceDirName":"discord","slug":"/discord/","permalink":"/personal-blog/docs/discord/","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1},"sidebar":"tutorialSidebar","next":{"title":"How to create database diagram animations","permalink":"/personal-blog/docs/diagrams/"}}');var i=n(6070),t=n(5658);const d={sidebar_position:1},a="How to create a multi-server discord economy bot",c={},o=[{value:"Intro",id:"intro",level:2},{value:"Single server economy bot",id:"single-server-economy-bot",level:2},{value:"Commands",id:"commands",level:3},{value:"/mint",id:"mint",level:4},{value:"/transfer <code>@user</code> <code>amount</code>",id:"transfer-user-amount",level:4},{value:"/wallet",id:"wallet",level:4},{value:"/top",id:"top",level:4},{value:"Pseudocode",id:"pseudocode",level:3},{value:"Multi-server discord economy bot",id:"multi-server-discord-economy-bot",level:2},{value:"Multi-server multi-currency discord economy bot",id:"multi-server-multi-currency-discord-economy-bot",level:2},{value:"Naive approach",id:"naive-approach",level:3},{value:"Better approach",id:"better-approach",level:3},{value:"Transactions and unit of work",id:"transactions-and-unit-of-work",level:3},{value:"Group types",id:"group-types",level:3},{value:"global - global economy",id:"global---global-economy",level:4},{value:"local - local economy",id:"local---local-economy",level:4},{value:"single - isolated economy",id:"single---isolated-economy",level:4},{value:"Fetch all members of a guild",id:"fetch-all-members-of-a-guild",level:3},{value:"Joining a global group",id:"joining-a-global-group",level:3},{value:"Trade across guilds through a master guild or with bank notes",id:"trade-across-guilds-through-a-master-guild-or-with-bank-notes",level:3},{value:"Leaderboard",id:"leaderboard",level:3},{value:"Audit",id:"audit",level:3}];function l(e){const r={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.header,{children:(0,i.jsx)(r.h1,{id:"how-to-create-a-multi-server-discord-economy-bot",children:"How to create a multi-server discord economy bot"})}),"\n",(0,i.jsx)(r.h2,{id:"intro",children:"Intro"}),"\n",(0,i.jsx)(r.p,{children:"I will be referencing these libraries and technologies in the article"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"https://nodejs.org",children:"node.js"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"https://discord.js.org/docs",children:"discord.js"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"https://www.typescriptlang.org",children:"typescript"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"https://orm.drizzle.team",children:"drizzle orm"})}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"single-server-economy-bot",children:"Single server economy bot"}),"\n",(0,i.jsx)(r.p,{children:"This bot listens to reactions and messages."}),"\n",(0,i.jsx)(r.p,{children:"If a reaction is a currency emoji then we mint a currency and insert it into the wallet of the message author."}),"\n",(0,i.jsx)(r.p,{children:"If a message is a command we execute the command. We check if the user has the permission or if application logic allows him to run this command."}),"\n",(0,i.jsx)(r.h3,{id:"commands",children:"Commands"}),"\n",(0,i.jsx)(r.h4,{id:"mint",children:"/mint"}),"\n",(0,i.jsx)(r.p,{children:"React with a designated emoji to a user message to create a currency token and insert it into wallet of the message author."}),"\n",(0,i.jsxs)(r.h4,{id:"transfer-user-amount",children:["/transfer ",(0,i.jsx)(r.code,{children:"@user"})," ",(0,i.jsx)(r.code,{children:"amount"})]}),"\n",(0,i.jsx)(r.p,{children:"Transfer some amount of currency to another user."}),"\n",(0,i.jsx)(r.h4,{id:"wallet",children:"/wallet"}),"\n",(0,i.jsx)(r.p,{children:"Check balanace."}),"\n",(0,i.jsx)(r.h4,{id:"top",children:"/top"}),"\n",(0,i.jsx)(r.p,{children:"List top 5 users."}),"\n",(0,i.jsx)(r.h3,{id:"pseudocode",children:"Pseudocode"}),"\n",(0,i.jsx)(r.p,{children:"Configuration is stored as environment variables."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"type Configuration = {\r\n    emojiId:   string  // currency\r\n    roleId:    string  // top 5 users role\r\n    guildId:   string  // discord bot server\r\n}\n"})}),"\n",(0,i.jsx)(r.p,{children:"User model and mock users. Users collection is stored into a json file."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"type User = {\r\n    id:      string\r\n    balance: number\r\n}\r\n\r\nconst users: User[] = JSON.parse(fs.readFile(`users.json`))\n"})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",metastring:'title="user.json"',children:'[\r\n    {"id": "00", "balance": 50 },\r\n    {"id": "01", "balance": 100},\r\n    {"id": "02", "balance": 25 },\r\n    {"id": "03", "balance": 30 },\r\n    {"id": "04", "balance": 1  },\r\n]\n'})}),"\n",(0,i.jsxs)(r.p,{children:["Example ",(0,i.jsx)(r.code,{children:"EconomyService"}),", with user in-memory storage. We create users lazily, only when they interact with the economy."]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"class EconomyService {\r\n    users: User[];\r\n    constructor(users: User[]) {\r\n        this.users = users;\r\n    }\r\n    mint(userId: string) {\r\n        const user = this.users.find(user => user.id === userId)\r\n        if(user) {\r\n            user.balance++;\r\n        }\r\n        else {\r\n            this.users.push({\r\n                id: userId,\r\n                balance: 1\r\n            })\r\n        }\r\n    }\r\n    transfer(from: string, to: string, amount: number) {\r\n        if(from === to) {\r\n            throw Error(`You can't send currency to yourself.`)\r\n        }\r\n        const fromUser = this.users.find(user => user.id === from)\r\n        if(!fromUser) {\r\n            throw Error(`User ${from} doesn't exist and can't transfer currency.`)\r\n        }\r\n        if(fromUser.balance >= amount) {\r\n            fromUser.balance -= amount;\r\n        }\r\n        else {\r\n            throw Error(`User doesn't have enough currency to complete this transfer.`)\r\n        }\r\n        let toUser = this.users.find(user => user.id === to)\r\n        if(toUser) {\r\n            toUser.balance += amount;\r\n        }\r\n        else {\r\n            this.users.push({\r\n                id: to,\r\n                balance: amount\r\n            })\r\n        }\r\n    }\r\n    wallet(userId: string) {\r\n        const user = this.users.find(user => user.id === userId)\r\n        return user?.balance || 0;\r\n    }\r\n    top(count: number = 5) {\r\n        return this.users.sort((a,b) => b.balance - a.balance).slice(0, count)\r\n    }\r\n}\n"})}),"\n",(0,i.jsx)(r.h2,{id:"multi-server-discord-economy-bot",children:"Multi-server discord economy bot"}),"\n",(0,i.jsx)(r.p,{children:"First step is to create a users database table from users collection. Then create guilds database table which will replace our static configuration and allow each guild to have it's own specific currency emoji, top role and bot nickname."}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.img,{alt:"2",src:n(1688).A+"",width:"1024",height:"720"})}),"\n",(0,i.jsx)(r.p,{children:"We will add new commands that guild admins will use to set currency emojis, rich roles and bot nickname."}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["/set_currency_emoji ",(0,i.jsx)(r.code,{children:"file_attachment"})," ",(0,i.jsx)(r.code,{children:"currency name"})]}),"\n",(0,i.jsxs)(r.li,{children:["/set_repost_channel ",(0,i.jsx)(r.code,{children:"#channel"})]}),"\n",(0,i.jsxs)(r.li,{children:["/set_top_role ",(0,i.jsx)(r.code,{children:"@role"})]}),"\n",(0,i.jsxs)(r.li,{children:["/set_nickname ",(0,i.jsx)(r.code,{children:"nickname"})]}),"\n"]}),"\n",(0,i.jsx)(r.admonition,{type:"info",children:(0,i.jsxs)(r.p,{children:["Checkout available ",(0,i.jsx)(r.a,{href:"https://discordjs.guide/slash-commands/advanced-creation.html#option-types",children:"slash commands argument option types"}),"."]})}),"\n",(0,i.jsx)(r.h2,{id:"multi-server-multi-currency-discord-economy-bot",children:"Multi-server multi-currency discord economy bot"}),"\n",(0,i.jsxs)(r.p,{children:["We will now expand our bot to able to handle ",(0,i.jsx)(r.strong,{children:"multiple currencies"})," in the single guild and persist currencies across guilds to form a ",(0,i.jsx)(r.strong,{children:"global economy"})," in which users can trade between guilds."]}),"\n",(0,i.jsx)(r.h3,{id:"naive-approach",children:"Naive approach"}),"\n",(0,i.jsx)(r.p,{children:"Use existing tables to add new currencies and user's wallets.\r\nLet's say our bot is in 2 guilds."}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"guild_id"}),(0,i.jsx)(r.th,{children:"nickname"}),(0,i.jsx)(r.th,{children:"currency"}),(0,i.jsx)(r.th,{children:"channel"}),(0,i.jsx)(r.th,{children:"role"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"1"}),(0,i.jsx)(r.td,{children:"broker"}),(0,i.jsx)(r.td,{children:"\u2764"}),(0,i.jsx)(r.td,{children:"#pinned"}),(0,i.jsx)(r.td,{children:"@amazing"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"2"}),(0,i.jsx)(r.td,{children:"banker"}),(0,i.jsx)(r.td,{children:"\ud83d\udcb0"}),(0,i.jsx)(r.td,{children:"#valuable"}),(0,i.jsx)(r.td,{children:"@rich"})]})]})]}),"\n",(0,i.jsx)(r.p,{children:"Guild 2 wants to add a new currency \ud83e\ude72."}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"guild_id"}),(0,i.jsx)(r.th,{children:"nickname"}),(0,i.jsx)(r.th,{children:"currency"}),(0,i.jsx)(r.th,{children:"channel_id"}),(0,i.jsx)(r.th,{children:"role_id"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"1"}),(0,i.jsx)(r.td,{children:"broker"}),(0,i.jsx)(r.td,{children:"\u2764"}),(0,i.jsx)(r.td,{children:"#pinned"}),(0,i.jsx)(r.td,{children:"@amazing"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"2"}),(0,i.jsx)(r.td,{children:"banker"}),(0,i.jsx)(r.td,{children:"\ud83d\udcb0"}),(0,i.jsx)(r.td,{children:"#valuable"}),(0,i.jsx)(r.td,{children:"@rich"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"2"}),(0,i.jsx)(r.td,{children:"banker"}),(0,i.jsx)(r.td,{children:"\ud83e\ude72"}),(0,i.jsx)(r.td,{children:"#valuable"}),(0,i.jsx)(r.td,{children:"@rich"})]})]})]}),"\n",(0,i.jsxs)(r.p,{children:["We have now duplicated all the original fields of the guild 2 and only replaced the ",(0,i.jsx)(r.code,{children:"emoji"})," in the new row."]}),"\n",(0,i.jsx)(r.admonition,{type:"caution",children:(0,i.jsxs)(r.p,{children:["Problem happens when we want to get all guilds. Now we have do it with a ",(0,i.jsx)(r.a,{href:"https://www.geeksforgeeks.org/sql-distinct-clause/",children:"sql distinct"})," operator.\r\nAnother problem happens when a guild admin wants to update some of the guild configuration like ",(0,i.jsx)(r.code,{children:"role"})," or ",(0,i.jsx)(r.code,{children:"nickname"}),". Now we have to update in two places, one time for each currency."]})}),"\n",(0,i.jsx)(r.p,{children:"I won't even try to create a global currency using this table because it will be very ugly."}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.p,{children:"We might also be tempted to use users table to store currency balance."}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"user"}),(0,i.jsx)(r.th,{children:"guild_id"}),(0,i.jsx)(r.th,{children:"currency"}),(0,i.jsx)(r.th,{children:"balance"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"\ud83e\uddd1"}),(0,i.jsx)(r.td,{children:"2"}),(0,i.jsx)(r.td,{children:"\ud83d\udcb0"}),(0,i.jsx)(r.td,{children:"5"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"\ud83e\uddd1"}),(0,i.jsx)(r.td,{children:"2"}),(0,i.jsx)(r.td,{children:"\ud83e\ude72"}),(0,i.jsx)(r.td,{children:"2"})]})]})]}),"\n",(0,i.jsx)(r.p,{children:"This becomes confusing once our users interact with the economy from multiple guilds."}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"user"}),(0,i.jsx)(r.th,{children:"guild_id"}),(0,i.jsx)(r.th,{children:"currency"}),(0,i.jsx)(r.th,{children:"balance"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"\ud83e\uddd1"}),(0,i.jsx)(r.td,{children:"2"}),(0,i.jsx)(r.td,{children:"\ud83d\udcb0"}),(0,i.jsx)(r.td,{children:"5"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"\ud83e\uddd1"}),(0,i.jsx)(r.td,{children:"2"}),(0,i.jsx)(r.td,{children:"\ud83e\ude72"}),(0,i.jsx)(r.td,{children:"2"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"\ud83e\uddd1"}),(0,i.jsx)(r.td,{children:"1"}),(0,i.jsx)(r.td,{children:"\u2764"}),(0,i.jsx)(r.td,{children:"3"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"\ud83e\udd36"}),(0,i.jsx)(r.td,{children:"2"}),(0,i.jsx)(r.td,{children:"\ud83d\udcb0"}),(0,i.jsx)(r.td,{children:"2"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"\ud83e\udd36"}),(0,i.jsx)(r.td,{children:"2"}),(0,i.jsx)(r.td,{children:"\ud83e\ude72"}),(0,i.jsx)(r.td,{children:"3"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"\ud83e\udd36"}),(0,i.jsx)(r.td,{children:"1"}),(0,i.jsx)(r.td,{children:"\u2764"}),(0,i.jsx)(r.td,{children:"4"})]})]})]}),"\n",(0,i.jsxs)(r.p,{children:["For the balance of a global currency - ",(0,i.jsx)(r.code,{children:"guild_id"})," will have to be a ",(0,i.jsx)(r.code,{children:"null"})," value."]}),"\n",(0,i.jsx)(r.admonition,{type:"caution",children:(0,i.jsx)(r.p,{children:"Users table will inherit similar problems to the guilds table, because we are using our tables for two purposes at the same time."})}),"\n",(0,i.jsx)(r.h3,{id:"better-approach",children:"Better approach"}),"\n",(0,i.jsx)(r.p,{children:"Separate currencies from the guilds table and separate wallets from the users table."}),"\n",(0,i.jsx)(r.p,{children:"Use foreign - primary key relationships between internal ids instead of discord ids."}),"\n",(0,i.jsx)(r.p,{children:"Distinguish between primary and secondary currencies, primary currency is used as the default transfer currency."}),"\n",(0,i.jsx)(r.p,{children:"User guild memberships is a junction table which will track which guild is user a part of."}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.img,{alt:"3",src:n(2817).A+"",width:"1024",height:"720"})}),"\n",(0,i.jsxs)(r.p,{children:["Lets revisit our ",(0,i.jsx)(r.code,{children:"EconomyService"})]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"class EconomyService {\r\n    createCurrency(discordGuildId: string, currencyEmojiId: string) {\r\n        /* create a new currency and make it\r\n           primary if it's the first currency created in this guild */\r\n    }\r\n    mint(userDiscordId: string, currencyEmojiId: string) {\r\n        /* 1. find user by userDiscordId\r\n           2. find currency by currencyEmojiId\r\n           3. find user's wallet by user.id and currency.id\r\n           4. update user's wallet balance */\r\n    }\r\n    transfer(\r\n        discordGuildId: string,\r\n        fromUserDiscordId: string,\r\n        toUserDiscordId: string,\r\n        amount: number,\r\n        currencyEmojiId?: string\r\n    ) {\r\n        /* 1. find currency by currencyEmojiId\r\n              or get default currency by discordGuildId if currencyEmojiId is undefined\r\n           2. find users with ids fromUserDiscordId and toUserDiscordId\r\n           3. find wallets by user ids and currency id\r\n           4. validate that the sender has the correct amount of balance in his wallet\r\n           5. update sender and receiver wallets\r\n        */\r\n    }\r\n    wallet(userId: string) {\r\n        /* find wallets by userId */\r\n    }\r\n    top(count: number = 5) {\r\n        /* implemented later when exchange rates between currencies are added */\r\n    }\r\n}\n"})}),"\n",(0,i.jsx)(r.admonition,{type:"caution",children:(0,i.jsx)(r.p,{children:"Now that we are dealing with a database, where we store and update data in an asynchronous way,\r\nfor one command like transfer which requires multiple updates to the database,\r\nand if any updates fail we'll want to reverse previous updates."})}),"\n",(0,i.jsx)(r.h3,{id:"transactions-and-unit-of-work",children:"Transactions and unit of work"}),"\n",(0,i.jsxs)(r.p,{children:["Database transactions with ",(0,i.jsx)(r.a,{href:"https://orm.drizzle.team/docs/transactions",children:"drizzle orm"})," and ",(0,i.jsx)(r.strong,{children:"unit of work"})," pattern."]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"export class UnitOfWork {\r\n    constructor(private context: DBContext) {}\r\n\r\n    async execute<T>(work: (repository: Repository) => Promise<T>): Promise<T | null> {\r\n        return this.context.transaction(async (tx) => {\r\n            try {\r\n                return await work(new Repository(tx))\r\n            } catch (error) {\r\n                console.error(error)\r\n                tx.rollback()\r\n                return null\r\n            }\r\n        })\r\n    }\r\n}\r\nexport const uow = new UnitOfWork(db)\n"})}),"\n",(0,i.jsxs)(r.p,{children:["Instead of injecting a ",(0,i.jsx)(r.code,{children:"DbContext"})," into our ",(0,i.jsx)(r.code,{children:"EconomyService"})," we inject a ",(0,i.jsx)(r.code,{children:"UnitOfWork"})," and then write a execute handler which will gives us a ",(0,i.jsx)(r.code,{children:"Repository"})," as an argument. ",(0,i.jsx)(r.code,{children:"Repository"})," will do all CRUD operations on the ",(0,i.jsx)(r.code,{children:"DbContext"}),". Outside of transactions we still use a ",(0,i.jsx)(r.code,{children:"Repository"})," with the global ",(0,i.jsx)(r.code,{children:"DbContext"}),"."]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"import { repository } from 'database/repository.ts'\r\n\r\nclass EconomyService {\r\n    uow: UnitOfWork;\r\n    constructor(uow: UnitOfWork) {\r\n        this.uow = uow;\r\n    }\r\n    ...\r\n    // this example lacks error handling\r\n    async transfer(\r\n        discordGuildId: string,\r\n        fromUserDiscordId: string,\r\n        toUserDiscordId: string,\r\n        amount: number,\r\n        currencyEmojiId?: string\r\n    ) {\r\n        const currency = currencyEmojiId\r\n            ? repository.getCurrency(currencyEmojiId)\r\n            : repository.getPrimaryCurrency(disocrdGuildId)\r\n        const sender = await repository.getUser(fromUserDiscordId)\r\n        const senderWallet = await repository.getWallet(sender.id, currency.id)\r\n        if(senderWallet.balance >= amount) {\r\n            // if any of the create or update methods inside this transaction fail, UnitOfWork will rollback them all of them\r\n            this.uow.execute(tx => {\r\n                const receiver = await this.tx.getOrCreateUser(toUserDiscordId)\r\n                const receiverWallet = await this.tx.getOrCreateWallet(receiver.id, currency.id)\r\n                senderWallet.balance -= amount\r\n                receiverWallet.balance += amount\r\n                await this.tx.updateWallets([senderWallet, receiverWallet])\r\n            })\r\n        }\r\n        else {\r\n            throw Error(`User ${sender.id} doesn't have enough currency ${currency.id} to complete this transfer.`)\r\n        }\r\n\r\n    }\r\n    ...\r\n}\r\n\n"})}),"\n",(0,i.jsx)(r.p,{children:"Now that we can have many currencies inside of a single guild, lets allow users to exchange one for another one by an exchange rate set by the guild admin."}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.img,{alt:"4",src:n(7982).A+"",width:"1024",height:"720"})}),"\n",(0,i.jsx)(r.p,{children:"One of our goals was to have a global economy. That would require a currency to be available in multiple guilds."}),"\n",(0,i.jsxs)(r.p,{children:["To achieve this I created a ",(0,i.jsx)(r.code,{children:"groups"})," and ",(0,i.jsx)(r.code,{children:"guild group membership"})," table, and changed ",(0,i.jsx)(r.code,{children:"currencies"})," table foreign key from ",(0,i.jsx)(r.code,{children:"guild_id"})," to ",(0,i.jsx)(r.code,{children:"group_id"}),"."]}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.img,{alt:"5",src:n(7479).A+"",width:"1024",height:"720"})}),"\n",(0,i.jsx)(r.h3,{id:"group-types",children:"Group types"}),"\n",(0,i.jsx)(r.h4,{id:"global---global-economy",children:"global - global economy"}),"\n",(0,i.jsx)(r.p,{children:"Currencies that belong to the global group persist across guilds and can earned in each guild that is part of the global group."}),"\n",(0,i.jsx)(r.p,{children:"Admin is the developer, only the developer can create global currencies and their exchange rates."}),"\n",(0,i.jsx)(r.h4,{id:"local---local-economy",children:"local - local economy"}),"\n",(0,i.jsx)(r.p,{children:"A guilds which share a currency in their local group."}),"\n",(0,i.jsx)(r.p,{children:"Out of the scope for this guide."}),"\n",(0,i.jsx)(r.h4,{id:"single---isolated-economy",children:"single - isolated economy"}),"\n",(0,i.jsx)(r.p,{children:'Every guild is part of a it\'s own "single" group, and each currency that is bound to the guild\'s "single" group is isolated from other guilds.\r\nAdmin is the guild admin.'}),"\n",(0,i.jsx)(r.admonition,{type:"info",children:(0,i.jsx)(r.p,{children:"Only the currencies of the same group can be exchanged for simplicity sake."})}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.p,{children:"We can no longer wait for users to interact with the economy to create them in our user's table.\r\nCertain work has to been done every time our bot is accepted into a guild.\r\nA user could have the most amount of global currency in a new guild that he has joined, but will not show in the leaderboards of that guild because he didn't yet interact with the economy from inside of that guild."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"...\r\nasync botAddedToGuild(guild) {\r\n      const commands = await getCommands()\r\n      await deployCommands(guild.id, commands)\r\n      const entity = await guildService.getOrCreateGuild(guild.id)\r\n      const members = await fetchAllMembers(guild.id)\r\n      await repository.addUserGuildMemberships(members, entity.id)\r\n}\r\n...\n"})}),"\n",(0,i.jsx)(r.h3,{id:"fetch-all-members-of-a-guild",children:"Fetch all members of a guild"}),"\n",(0,i.jsx)(r.p,{children:"Fetching all guild members must be done in batches of max a 1000 users and the maximum number of guild members is 1,000,000"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:'export const rest = new REST().setToken(token)\r\n\r\nexport async function fetchAllMembers(guildId: string) {\r\n  const query = new URLSearchParams()\r\n  query.set("limit", "1000")\r\n\r\n  let members: string[] = []\r\n  let batch: Collection<string, GuildMember> = new Collection()\r\n  do {\r\n    if (members.length > 0) {\r\n      query.set("after", members.at(-1))\r\n    }\r\n    const batch = (await rest.get(`/guilds/${guildId}/members`, {\r\n      query,\r\n    })) as GuildMember[]\r\n    members.push(...batch.map((member) => member.user.id))\r\n  } while (batch.size > 0)\r\n\r\n  return members\r\n}\n'})}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.p,{children:"We need new commands to allow group admins to manage these new parts of the economy"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"/currencies"}),"\n",(0,i.jsxs)(r.li,{children:["/make_currency_primary ",(0,i.jsx)(r.code,{children:":currency_emoji_name:"})]}),"\n",(0,i.jsxs)(r.li,{children:["/create_exchange_rate ",(0,i.jsx)(r.code,{children:":from_currency:"})," ",(0,i.jsx)(r.code,{children:":to_currency:"})," ",(0,i.jsx)(r.code,{children:"rate"})]}),"\n",(0,i.jsxs)(r.li,{children:["/exchange ",(0,i.jsx)(r.code,{children:":from_currency:"})," ",(0,i.jsx)(r.code,{children:":to_currency:"})," ",(0,i.jsx)(r.code,{children:"amount"})]}),"\n",(0,i.jsxs)(r.li,{children:["/transfer ",(0,i.jsx)(r.code,{children:"@user"})," ",(0,i.jsx)(r.code,{children:"amount"})," ",(0,i.jsx)(r.code,{children:"?:currency:"})]}),"\n",(0,i.jsx)(r.li,{children:"/join_global_group"}),"\n"]}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h3,{id:"joining-a-global-group",children:"Joining a global group"}),"\n",(0,i.jsxs)(r.p,{children:["When a guild joins a global guild group we must install all the global currencies in that guild. We install them using the ",(0,i.jsx)(r.a,{href:"https://discord.js.org/docs/packages/rest/main",children:"discord.js REST API client"}),"."]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"async joinGlobalGroup(discordGuildId: string) {\r\n    const guild = await repository.getGuildByDiscordGuildId(discordGuildId)\r\n    await repository.createGuildMembership({\r\n      groupId: globalGroupId,\r\n      guildId: guild.id,\r\n    })\r\n\r\n    const currencies = await repository.getCurrenciesByGroupId(globalGroupId)\r\n      const emojis = await Promise.all(\r\n        currencies.map((currency) =>\r\n          fetch(rest.cdn.emoji(currency.discordEmojiId))\r\n            .then((response) => response.arrayBuffer())\r\n            .then((buffer) => createEmoji(guild.discordGuildId, currency.name, buffer))\r\n        )\r\n      )\r\n}\r\n\n"})}),"\n",(0,i.jsx)(r.h3,{id:"trade-across-guilds-through-a-master-guild-or-with-bank-notes",children:"Trade across guilds through a master guild or with bank notes"}),"\n",(0,i.jsxs)(r.p,{children:['Currently users can trade their global currencies only if they are part of the same guild. We could refer all users wanting to trade in the global economy to the single "',(0,i.jsx)(r.strong,{children:"master"}),'" guild which could serve as a global marketplace.']}),"\n",(0,i.jsxs)(r.p,{children:["Let's create a way for users to transfer currency even if they're not a part of the same guild using \"",(0,i.jsx)(r.strong,{children:"bank notes"}),'".']}),"\n",(0,i.jsx)(r.p,{children:"Bank note should be a one-time consumable, secure and transparent object that is signed over to the a single recepient.  It should be self-contained and sharable as text."}),"\n",(0,i.jsx)(r.p,{children:"Bank note trade flow goes like this:"}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:["Sender ",(0,i.jsx)(r.a,{href:"https://support.discord.com/hc/en-us/articles/206346498-Where-can-I-find-my-User-Server-Message-ID#h_01HRSTXPS5H5D7JBY2QKKPVKNA",children:"copies id of the discord user"})," he wants to share this bank note to."]}),"\n",(0,i.jsx)(r.li,{children:"Sender issues a command to the discord bot to create a bank note which contains recepient discord id and some amount of currency."}),"\n",(0,i.jsx)(r.li,{children:"Sender receives a token that he sends to the recepient in discord chat."}),"\n",(0,i.jsx)(r.li,{children:"Recepient has a permanently valid bank note which he can consume at any point by issuing a command to the bot. He will need to be in a server which has our bot present, but doesn't have to be in the same server as the sender."}),"\n"]}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.a,{href:"https://jwt.io",children:"JWT Web Token"})," has these properties so we will use it's mechanism for our bank notes."]}),"\n",(0,i.jsxs)(r.p,{children:["Encoded token with 3 parts separated by a dot.\r\n",(0,i.jsx)(r.code,{children:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjdXJyZW5jeUlkIjoxLCJhbW91bnQiOjEsImp0aSI6Ijg5MGZjOTQ5LTBkMWMtNDdiZi05NjA5LTg5ZDg0NzMyMDYzOCIsInJlY2lwaWVudElkIjoiNTYzNDM3MzQ3ODk5OTY1NDU1In0.AinV8D0nPOtMvrdydrPi64F77U1dJ9GIcp3DuzYO_04"})]}),"\n",(0,i.jsx)(r.p,{children:"Decoded JWT token has 3 parts"}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:["Identifies which algorithm is used to generate the signature. In the below example, ",(0,i.jsx)(r.a,{href:"https://en.wikipedia.org/wiki/SHA-2",children:"HS256"})," indicates that this token is signed using HMAC-SHA256."]}),"\n"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",metastring:'title="header"',children:'{\r\n  "alg": "HS256",\r\n  "typ": "JWT"\r\n}\n'})}),"\n",(0,i.jsxs)(r.ol,{start:"2",children:["\n",(0,i.jsx)(r.li,{children:"Describes our bank note."}),"\n"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",metastring:'title="payload"',children:'{\r\n  "currencyId": 1,        // currency primary id key\r\n  "amount": 1,            // fixed amount of currency\r\n  "jti": "asdfgh",        // unique id\r\n  "recipientId": "12345"  // discord user id\r\n}\n'})}),"\n",(0,i.jsxs)(r.ol,{start:"3",children:["\n",(0,i.jsxs)(r.li,{children:["Securely validates the token. The signature is calculated by encoding the header and payload using ",(0,i.jsx)(r.a,{href:"https://en.wikipedia.org/wiki/Base64#URL_applications",children:"Base64url Encoding"})," ",(0,i.jsx)(r.a,{href:"https://datatracker.ietf.org/doc/html/rfc4648",children:"RFC 4648"})," and concatenating the two together with a period separator. That string is then run through the cryptographic algorithm specified in the header."]}),"\n"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",metastring:'title="verify signature"',children:"const token = base64urlEncoding(header)\r\n+ '.' + base64urlEncoding(payload)\r\n+ '.' + base64urlEncoding(signature)\n"})}),"\n",(0,i.jsxs)(r.p,{children:["Bank note ",(0,i.jsx)(r.strong,{children:"can be consumed only once"}),".\r\nWe will create a new database table which will hold all bank notes, with a column indicating if the bank note has been consumed or not."]}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.img,{alt:"6",src:n(9900).A+"",width:"1024",height:"720"})}),"\n",(0,i.jsxs)(r.p,{children:["Bank note is ",(0,i.jsx)(r.strong,{children:"transparent"})," because anyone can decode it to see the payload that contains the amount, currency and recepient."]}),"\n",(0,i.jsxs)(r.p,{children:["Bank note is ",(0,i.jsx)(r.strong,{children:"secure"})," because it becomes invalid if the payload has been altered in any way."]}),"\n",(0,i.jsxs)(r.p,{children:["Bank note ",(0,i.jsx)(r.strong,{children:"can be consumed only by a single discord user"})," choosen by the sender at the time when the bank note was created."]}),"\n",(0,i.jsx)(r.h3,{id:"leaderboard",children:"Leaderboard"}),"\n",(0,i.jsx)(r.p,{children:"Now we can implement our top 5 leaderboard for users of a guild."}),"\n",(0,i.jsx)(r.p,{children:"It will sum all user wallets that can be directly exchanged to the target currency."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:'async top5(discordGuildId: string, currencyId?: number | undefined) {\r\n    let currency = currencyId\r\n      ? await repository.getCurrencyById(currencyId)\r\n      : await this.getDefaultTransferCurrencyForGuild(discordGuildId)\r\n\r\n    const guildUsers = await db\r\n      .select({\r\n        discordId: users.discordId,\r\n        count: sql`\r\n            SUM(\r\n                CASE\r\n                    WHEN ${wallets.currencyId} = ${currencyId}\r\n                        THEN CAST(${wallets.count} AS NUMERIC)\r\n                    WHEN ${exchangeRates.quoteCurrencyId} = ${currencyId}\r\n                        THEN CAST(${wallets.count} AS NUMERIC) * CAST(${exchangeRates.rate} AS NUMERIC)\r\n                    ELSE 0\r\n                END\r\n            )`.mapWith(Number).as("count"),\r\n      })\r\n      .from(users)\r\n      .innerJoin(userGuildMemberships, eq(userGuildMemberships.userId, users.id))\r\n      .innerJoin(guilds, eq(guilds.id, userGuildMemberships.guildId))\r\n      .innerJoin(wallets, eq(wallets.userId, users.id))\r\n      .innerJoin(currencies, eq(currencies.id, wallets.currencyId))\r\n      .leftJoin(exchangeRates, eq(exchangeRates.baseCurrencyId, currencies.id))\r\n      .where(\r\n        and(\r\n          currency.groupId === null\r\n            ? isNull(currencies.groupId)\r\n            : eq(currencies.groupId, currency.groupId),\r\n          eq(guilds.discordGuildId, discordGuildId)\r\n        )\r\n      )\r\n      .groupBy(users.discordId)\r\n      .orderBy(({ count }) => desc(count))\r\n      .limit(5)\r\n\r\n    return { top: guildUsers, currency: currency }\r\n  }\n'})}),"\n",(0,i.jsx)(r.h3,{id:"audit",children:"Audit"}),"\n",(0,i.jsx)(r.p,{children:"To track the history of all economy activity we can create an audit table filled with events that are marked with these types:"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"minting"}),"\n",(0,i.jsx)(r.li,{children:"burning"}),"\n",(0,i.jsx)(r.li,{children:"exchanges"}),"\n",(0,i.jsx)(r.li,{children:"transfers"}),"\n",(0,i.jsx)(r.li,{children:"create bank note"}),"\n",(0,i.jsx)(r.li,{children:"consume bank note"}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"When some of these actions happen we will create a audit object, add it to the queue and that queue will be persisted to memory every minute. That way we batch our inserts and prevent overwhelming the database."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"class Queue<T> {\r\n  private array: T[] = []\r\n  constructor() {}\r\n  add(...items: T[]) {\r\n    this.array.unshift(...items)\r\n  }\r\n  pull(count: number): T[] {\r\n    let start = this.array.length - count\r\n    return this.array.splice(start < 0 ? 0 : start, count)\r\n  }\r\n  all(): ReadonlyArray<T> {\r\n    return this.array as ReadonlyArray<T>\r\n  }\r\n  get length(): number {\r\n    return this.array.length\r\n  }\r\n}\r\n\r\nexport const transactionQueue = new Queue<Transaction>()\r\n\r\n// insert 1000 transactions from the queue every minute\r\n// if there is more than a 1000 transactions send an alert to a discord channel\r\nsetInterval(() => {\r\n  const batch = transactionQueue.pull(1000)\r\n  if (batch.length > 0) {\r\n    db.insert(transactions)\r\n      .values(batch)\r\n      .catch((err) => {\r\n        // on error return the batch to the queue\r\n        transactionQueue.add(...batch)\r\n      })\r\n  }\r\n}, 60 * 1000)\n"})}),"\n",(0,i.jsxs)(r.p,{children:["Learn how I made these database diagrams ",(0,i.jsx)(r.a,{href:"/docs/diagrams",children:"HERE"}),"."]})]})}function h(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},1688:(e,r,n)=>{n.d(r,{A:()=>s});const s=n.p+"assets/images/d2-f79f1574d4c409201275ad6357fd0742.png"},2817:(e,r,n)=>{n.d(r,{A:()=>s});const s=n.p+"assets/images/d3-481bd7bcfc14ac0c8be3fc0fad412ba6.png"},7982:(e,r,n)=>{n.d(r,{A:()=>s});const s=n.p+"assets/images/d4-3326ff1b2f20abed5883ea90774f97fa.png"},7479:(e,r,n)=>{n.d(r,{A:()=>s});const s=n.p+"assets/images/d5-b597fadd5fff3ace2b7389950cbda6b7.png"},9900:(e,r,n)=>{n.d(r,{A:()=>s});const s=n.p+"assets/images/d6-2e96effd4970f708c6388d1b7312493b.png"},5658:(e,r,n)=>{n.d(r,{R:()=>d,x:()=>a});var s=n(758);const i={},t=s.createContext(i);function d(e){const r=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),s.createElement(t.Provider,{value:r},e.children)}}}]);